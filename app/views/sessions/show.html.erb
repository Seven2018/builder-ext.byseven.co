<div class="container-session-show">
  <div class="session-container">
    <div class="training-info-headers">
      <%= link_to training_path(@session.training), class: 'btn return-arrow' do %>
        <i class="fas fa-arrow-left"></i>
      <% end %>
      <div>
        <a class='edit-fafa btn btn-edit btn-edit-pen' data-toggle='modal' data-target='#editSession'><i class="fas fa-pen"></i></a>
        <button class='btn btn-edit-grey btn-edit-menu dropdown-toggle' id="dropdownMenuButton" data-toggle="dropdown"><i class="fas fa-ellipsis-h"></i></button>
        <ul class="dropdown-menu dropdown-menu-right navbar-wagon-dropdown-menu" aria-labelledby="dropdownMenuButton">
          <li><%= link_to 'View mode', session_viewer_path(@session) %></li>
          <li><%= link_to 'Export PDF', training_session_path(@session.training, @session, format: :pdf) %></li>
          <li><%= link_to 'Participants List', export_attendees_path(@session.training, @session) %></li>
        </ul>
      </div>
    </div>
    <div class="middle-info">
      <div class="middle-info-main">
        <h3 id='session-title'><%= @session.title %>
        </h3>
      </div>
      <div>
        <div style="display: table;margin: 0 auto">
          <ul id='owner'>
            <% @session.users.each do |user| %>
              <li>
                <a data-toggle='modal' data-target='#consultUser<%= user.id %>'><img src='<%= "#{user.picture}" %>' alt="" class='avatar-sm'></a>
              </li>
            <% end %>
            <li><button class='btn btn-add-user' data-toggle='modal' data-target='#newUser'>Trainers</button></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="session-info">
      <% if @session.start_time && @session.end_time %>
        <p> <%="#{@session.date.strftime('%d/%m/%y')}"%> </p>
        <div><p><%= " #{@session.start_time.strftime("%k:%M")} to #{@session.end_time.strftime("%k:%M")}" %></p></div>
        <i class="fas fa-users"> <%= @session.attendee_number %></i>
      <% end %>
    </div>
    <div id="mods" style="min-height: 70vh;">
      <% if !@session.description.nil? %>
        <%= @session.description.html_safe %>
      <% else %>
        <%= render 'workshops/index', session: @session %>
      <% end %>
    </div>
    <div class="comment-box">
      <div class="message-box">
        <h4>Ajouter un message</h4>
        <%= simple_form_for [@session.training, @session, @comment] do |f| %>
          <%= f.input :object, placeholder: "Objet", input_html: { style: "width: 100%; heigth: 50px;"}, label: false %>
          <%= f.input :content, placeholder: "Message", input_html: { style: "width: 100%; heigth: 50px;"}, label: false %>
          <div class='center-button'> <%= f.submit 'Publier', class: 'btn btn-edit'%> </div>
        <% end %>
      </div>
      <div class='log-box'>
        <h4>Messages</h4>
        <ul>
          <% @session.comments.each do |comment| %>
            <% if comment.object != "Log" %>
              <li class="logs-message"><%= "#{comment.object} on #{comment.created_at.strftime(("%d/%m/%Y at %H:%M"))} by #{comment.user.firstname}" %>
                <br>
                <%= "#{comment.content}" %>
              </li>
              <% end %>
          <% end %>
        </ul>
      </div>
    </div>
    <div class="log-box">
      <h4 id='logs-title'>Log Records<span>Click to see</span></h4>
      <div id='logs-list' class='hidden'>
        <%= render 'comments', session: @session  %>
      </div>
    </div>
    <script>
      button = document.getElementById('logs-title');
      list = document.getElementById('logs-list');
      button.addEventListener('click', (event) => {
        list.classList.toggle('hidden');
      })
    </script>
  </div>
  <% if (['super admin', 'admin', 'training manager'].include? current_user.access_level) && @session.description.nil? %>
    <div class="nav-side-menu-container">
      <div class="nav-side-menu">
        <div class="brand">Workshops</div>
        <i class="fa fa-bars fa-2x toggle-btn" data-toggle="collapse" data-target="#menu-content"></i>
        <div class="menu-list">
          <% status = !params[:search].nil? %>
          <%= simple_form_for :search, url: training_session_path(@session.training, @session), html: { class: 'sidebar-search' }, method: 'GET' do |f| %>
            <%= f.input :title, placeholder: 'Search', label: false %>
          <% end %>
          <% if status %>
            <ul id='myUL'>
              <% (Content.where("lower(title) LIKE :query", query: "%#{params[:search][:title].downcase}%") + (Content.joins(:content_modules).where("lower(content_modules.title) LIKE :query", query:"%#{params[:search][:title].downcase}%"))).each do |content| %>
                <%= link_to training_session_workshops_path(@session.training, @session, content_id: content.id), method: :post, remote: true do %>
                  <li class='myUL-li-theme-sidebar'>+ <%= content.title %></li>
                <% end %>
              <% end %>
            </ul>
          <% else %>
            <ul id='myUL' class='myUL-sidebar'>
              <% Theme.walk_tree do |theme, level| %>
                <% if theme.children.empty? && theme.level == 0 && !['Ice breaker', 'Présentation', 'Conclusion'].include?(theme.name) %>
                  <li><span class="caret sidebar-caret"><%= theme.name %></span>
                    <ul class="nested">
                      <% theme.contents.each do |content| %>
                        <%= link_to training_session_workshops_path(@session.training, @session, content_id: content.id), method: :post, remote: true do %>
                          <li>+ <%= content.title %></li>
                        <% end %>
                      <% end %>
                    </ul>
                  </li>
                <% elsif theme.level == 0 && theme.children != [] %>
                  <li><span class="caret sidebar-caret"><%= theme.name %></span>
                    <ul class="nested">
                      <% theme.children.each do |subtheme| %>
                        <li><span class="caret"><%= subtheme.name %></span>
                          <ul class="nested">
                            <% subtheme.contents.each do |content| %>
                              <%= link_to training_session_workshops_path(@session.training, @session, content_id: content.id), method: :post, remote: true do %>
                                <li>+ <%= content.title %></li>
                              <% end %>
                            <% end %>
                          </ul>
                        </li>
                      <% end %>
                    </ul>
                  </li>
                <% end %>
              <% end %>
              <%= link_to training_session_workshops_path(@session.training, @session), method: :post, remote: true do %>
                <li>Vide - à personnaliser</li>
              <% end %>
              <% pause = Content.where(title: 'Pause') %>
              <% pausedej = Content.where(title: 'Pause Déjeuner') %>
              <%= link_to training_session_workshops_path(@session.training, @session, content_id: pause.first.id), method: :post, remote: true do %>
                <li>Pause</li>
              <% end %>
              <%= link_to training_session_workshops_path(@session.training, @session, content_id: pausedej.first.id), method: :post, remote: true do %>
                <li>Pause Déjeuner</li>
              <% end %>
            </ul>
            <br>
            <ul id='myUL' class='myUL-sidebar'>
              <% @themes.each do |theme| %>
                <% if ['Ice breaker', 'Présentation', 'Conclusion'].include?(theme.name) %>
                  <li><span class="caret sidebar-caret"><%= theme.name %></span>
                    <ul class="nested">
                      <% theme.contents.each do |content| %>
                        <%= link_to training_session_workshops_path(@session.training, @session, content_id: content.id), method: :post, remote: true do %>
                          <li>+ <%= content.title %></li>
                        <% end %>
                      <% end %>
                    </ul>
                  </li>
                <% end %>
              <% end %>
            </ul>
          <% end %>
        </div>
        <script src="/javascript/plugins/tree.js" type="text/javascript"></script>
      </div>
    </div>
  <% end %>
</div>


<!-- Modals -->
<div class="modal fade" id="editSession" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document" style="border-radius: 20px">
    <%= render 'edit', session: @session %>
  </div>
</div>

<div class="modal fade" id="newUser" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document" style="border-radius: 20px">
    <%= render 'session_trainers/new', session: @session, session_trainer: @session_trainer %>
  </div>
</div>

<% @session.users.each do |user| %>
  <div class="modal fade" id="consultUser<%= user.id %>" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document" style="border-radius: 20px">
      <%= render 'users/consult', user: user %>
    </div>
  </div>
<% end %>

<script>
  $(document).ready(function() {
    $('[data-toggle="tooltip"]').tooltip({container: 'body'});
  });
</script>
