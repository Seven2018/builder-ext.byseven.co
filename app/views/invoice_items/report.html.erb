<div class="container-seven-large">
  <div class="report-main">
    <div id="page-controls">
      <h1>Reports</h1>
      <div id="page-buttons">
        <%= link_to 'Invoices', invoice_items_path(type: 'Invoice'), class: 'btn btn-edit-green btn-edit-trash' %>
        <%= link_to 'Estimates', invoice_items_path(type: 'Estimate'), class: 'btn btn-edit btn-edit-trash' %>
        <button class='btn btn-edit-grey btn-edit-menu dropdown-toggle' id="dropdownMenuButton" data-toggle="dropdown"><i class="fas fa-ellipsis-h"></i></button>
        <ul class="dropdown-menu dropdown-menu-right navbar-wagon-dropdown-menu" aria-labelledby="dropdownMenuButton">
          <li><%= link_to 'Upload to Drive', upload_to_sheet_path, method: :post %></li>
        </ul>
      </div>
    </div>
    <p>Billed this year: <%= number_with_precision(@invoice_items.where("created_at > ? AND created_at < ?", Time.now.beginning_of_year, Time.now.end_of_year).map(&:gross_revenue).sum, precision: 2) %>€</p>
    <p>Billed this month: <%= number_with_precision(@invoice_items.where("created_at > ? AND created_at < ?", Time.now.beginning_of_month, Time.now.end_of_month).map(&:gross_revenue).sum, precision: 2) %>€</p>
    <p>Unpaid this year: <%= number_with_precision(@invoice_items.where("created_at > ? AND created_at < ?", Time.now.beginning_of_year, Time.now.end_of_year).where(payment_date: nil).map(&:gross_revenue).sum, precision: 2) %>€</p>
    <br>
    <div>
      <div id="report_monthly_hour_search">

      </div>
      <div id="report_monthly_hours">
        <p>Hours of Training this month: <%= Session.where("date > ? AND date < ?", Time.now.beginning_of_month, Time.now.end_of_month).map(&:duration).sum %>h</p>
      </div>
    </div>
    <div>
      <div id="report_weekly_hours">
        <% hours_count = 0 %>
        <% Session.where("date > ? AND date < ?", Time.now.beginning_of_week, Time.now.end_of_week).each do |session| %>
          <% hours_count += session.duration * session.session_trainers.count if session.session_trainers.count >= 1 %>
          <% hours_count += session.duration if session.session_trainers.count == 0 %>
        <% end %>
        <p>Hours of Training this week: <%= hours_count %>h</p>
      </div>
    </div>
  </div>
  <div id="numbers_training" class="table-container" role="table" aria-label="Trainings">
    <div id="numbers_training_headers" class="flex-table header" role="rowgroup">
      <p class="flex-row">Title</p>
      <p class="flex-row">Client</p>
      <p class="flex-row">Dates</p>
      <p class="flex-row">Owner</p>
      <p class="flex-row">Trainers</p>
      <p class="flex-row">Hours</p>
      <p class="flex-row">Invoices</p>
      <p class="flex-row">Sales</p>
      <p class="flex-row">Comments</p>
    </div>
    <div id="numbers_training_data">
      <% trainings = Training.numbers_scope %>
      <% trainings.each do |training| %>
        <div class="flex-table" role="rowgroup">
          <p class="flex-row" role="cell"><%= link_to training.title, training_path(training) %></p>
          <p class="flex-row" role="cell"><%= training.client_company.name %></p>
          <p class="flex-row" role="cell"><%= training.sessions.order(date: :asc)&.first&.date&.strftime('%d/%m/%y') %> - <%= training.sessions.order(date: :asc)&.first&.date&.strftime('%d/%m/%y') %></p>
          <p class="flex-row" role="cell"><%= training.users.first.fullname %></p>
          <p class="flex-row" role="cell">
            <% training&.trainers.each do |trainer| %>
              <span data-toggle="tooltip" title="<%= trainer.fullname %>"><%= trainer.fullname %></span> <br>
            <% end %>
          </p>
          <p class="flex-row" role="cell"><%= training.sessions.map(&:duration).sum %></p>
          <p class="flex-row" role="cell">
            <% training.invoice_items.order(created_at: :asc).each do |invoice| %>
              <% if invoice.type == 'Invoice' %>
                <%= link_to "#{invoice.uuid}", invoice_item_path(invoice) %> <br>
              <% end %>
            <% end %>
          </p>
          <p class="flex-row" role="cell">
            <% result = 0 %>
            <% training.invoice_items.each do |invoice| %>
              <% if invoice.type == 'Invoice' %>
                <% invoice.invoice_lines.each do |line| %>
                  <% if [1, 2, 3, 7, 9].include?(line.product.id) %>
                    <% result += (line.net_amount * line.quantity)%>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <%= number_with_precision(result, precision: 2) %>€
          </p>
        </div>
      <% end %>
    </div>
  </div>
</div>
